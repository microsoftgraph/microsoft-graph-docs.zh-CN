---
title: Microsoft Graph 数据连接的相关使用提示
description: 获取可帮助你利用 Microsoft Graph 数据连接的相关提示。
author: tlenig
localization_priority: Priority
ms.prod: data-connect
ms.openlocfilehash: d9a87c629a80bc94c57e77bd0f2c0b1e7438c935
ms.sourcegitcommit: d700b7e3b411e3226b5adf1f213539f05fe802e8
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 05/19/2021
ms.locfileid: "52547602"
---
# <a name="tips-for-using-microsoft-graph-data-connect"></a><span data-ttu-id="3412a-103">Microsoft Graph 数据连接的相关使用提示</span><span class="sxs-lookup"><span data-stu-id="3412a-103">Tips for using Microsoft Graph data connect</span></span>

<span data-ttu-id="3412a-104">借助 Microsoft Graph 数据连接，开发人员可为客户创建应用程序，用以提供对其大规模的 Microsoft Graph 数据库的受管理的访问服务。</span><span class="sxs-lookup"><span data-stu-id="3412a-104">Microsoft Graph data connect allows developers to create applications that customers can provide managed access to their at-scale Microsoft Graph datasets.</span></span> <span data-ttu-id="3412a-105">本文提供了可帮助你使用数据连接功能的提示。</span><span class="sxs-lookup"><span data-stu-id="3412a-105">This article provides tips that will help you take advantage of the data connect feature.</span></span> <span data-ttu-id="3412a-106">有关 Microsoft Graph 数据连接的简介，请参阅[概述](data-connect-concept-overview.md)文章。</span><span class="sxs-lookup"><span data-stu-id="3412a-106">For an introduction to Microsoft Graph data connect, see the [Overview](data-connect-concept-overview.md) article.</span></span>

## <a name="is-microsoft-graph-data-connect-right-for-you"></a><span data-ttu-id="3412a-107">Microsoft Graph 数据连接是否适合你？</span><span class="sxs-lookup"><span data-stu-id="3412a-107">Is Microsoft Graph data connect right for you?</span></span>

<span data-ttu-id="3412a-108">数据连接和 Microsoft Graph API 可以完全不同的方式访问相同的基础数据。</span><span class="sxs-lookup"><span data-stu-id="3412a-108">Data connect and the Microsoft Graph APIs provide access to the same underlying data but in very different ways.</span></span> <span data-ttu-id="3412a-109">数据连接旨在批量提取大量数据，而 Microsoft Graph API 更适合于实时访问分散的数据集。</span><span class="sxs-lookup"><span data-stu-id="3412a-109">Data connect is designed to extract large amounts of data in bulk while the Microsoft Graph APIs are more suitable for accessing discrete sets of data in real time.</span></span> <span data-ttu-id="3412a-110">在某些情况下，将两者组合使用可能极具意义。</span><span class="sxs-lookup"><span data-stu-id="3412a-110">In some cases, it might even make sense to combine them.</span></span> <span data-ttu-id="3412a-111">例如，可以使用数据连接来对去年的电子邮件数据进行初步提取，再使用 Microsoft Graph API 实时动态分析不断变化地电子邮件。</span><span class="sxs-lookup"><span data-stu-id="3412a-111">For example, you might want use data connect to do an initial extraction of the last year of email data, and then use the Microsoft Graph APIs to analyze emails in real time moving forward.</span></span> <span data-ttu-id="3412a-112">数据连接和 Microsoft Graph API 是针对不同工作的不同工具。</span><span class="sxs-lookup"><span data-stu-id="3412a-112">Data connect and the Microsoft Graph APIs are different tools for different jobs.</span></span> <span data-ttu-id="3412a-113">有必要思考哪种访问方法最适合你的场景。</span><span class="sxs-lookup"><span data-stu-id="3412a-113">It's important to think about which access method best fits your scenario.</span></span>

## <a name="expect-an-initial-overhead"></a><span data-ttu-id="3412a-114">预估初始开销</span><span class="sxs-lookup"><span data-stu-id="3412a-114">Expect an initial overhead</span></span>

<span data-ttu-id="3412a-115">数据连接专用于批量提取大量数据，因此在提取数据之前可能会产生一些开销。</span><span class="sxs-lookup"><span data-stu-id="3412a-115">Because data connect is designed to extract large amounts of data in bulk, some overhead is incurred before the data can be extracted.</span></span> <span data-ttu-id="3412a-116">此开销大约为 45 分钟，这意味着无论数据量如何，所有管道至少都将花费这么长时间。</span><span class="sxs-lookup"><span data-stu-id="3412a-116">This overhead is around 45 minutes, meaning all pipelines will take at least that long regardless of the data size.</span></span> <span data-ttu-id="3412a-117">数据量庞大时，这一成本可忽略不计；但是如果你的场景无法承受这么长的时间，Microsoft Graph API 可提供更好的方法。</span><span class="sxs-lookup"><span data-stu-id="3412a-117">This might be a negligible cost for large amounts of data, but if this time is unacceptable for your scenario, the Microsoft Graph APIs might provide a better approach.</span></span>

## <a name="data-must-stay-within-the-organizations-subscription"></a><span data-ttu-id="3412a-118">数据必须保留在组织的订阅中。</span><span class="sxs-lookup"><span data-stu-id="3412a-118">Data must stay within the organization's subscription</span></span>

<span data-ttu-id="3412a-119">数据连接管道由 Azure 数据工厂进行安排，后者是一项在 Azure 订阅中运行的数据集成服务。</span><span class="sxs-lookup"><span data-stu-id="3412a-119">Data connect pipelines are orchestrated by Azure Data Factory, a data integration service that runs in an Azure subscription.</span></span> <span data-ttu-id="3412a-120">Azure 订阅[与 Microsoft 365 租户一对一关联](/azure/active-directory/fundamentals/active-directory-how-subscriptions-associated-directory)。</span><span class="sxs-lookup"><span data-stu-id="3412a-120">The Azure subscription is [associated with exactly one Microsoft 365 tenant](/azure/active-directory/fundamentals/active-directory-how-subscriptions-associated-directory).</span></span> <span data-ttu-id="3412a-121">这样的话，数据一开始必须传输到关联的 Azure 订阅。</span><span class="sxs-lookup"><span data-stu-id="3412a-121">This way, the data must initially flow to an associated Azure subscription.</span></span> <span data-ttu-id="3412a-122">在进一步最小化和聚合后，数据可在其他位置使用。</span><span class="sxs-lookup"><span data-stu-id="3412a-122">After further minimalization and aggregation, the data can be used elsewhere.</span></span>

<span data-ttu-id="3412a-123">如果想要构建供其他人用来提取其 Microsoft 365 数据的应用，可将应用打包为 [Azure 托管应用](/azure/managed-applications/overview)，再将其发布到 Azure 市场。</span><span class="sxs-lookup"><span data-stu-id="3412a-123">If you want to build an app for others to use to extract their Microsoft 365 data, you can package the app as an [Azure managed application](/azure/managed-applications/overview) and publish it to the Azure Marketplace.</span></span> <span data-ttu-id="3412a-124">之后，其他人可在其自己的 Azure 订阅中部署你的应用，而该应用也能访问其租户中的数据。</span><span class="sxs-lookup"><span data-stu-id="3412a-124">Then someone can deploy your app into their own Azure subscription, and the app can access data in their tenant.</span></span> 

## <a name="use-of-service-principals"></a><span data-ttu-id="3412a-125">服务主体的使用</span><span class="sxs-lookup"><span data-stu-id="3412a-125">Use of service principals</span></span>

<span data-ttu-id="3412a-126">创建数据工厂管道时，必须向 Microsoft 365 链接的服务提供服务主体。</span><span class="sxs-lookup"><span data-stu-id="3412a-126">When creating the Data Factory pipeline, you will have to provide a service principal to the Microsoft 365 linked service.</span></span> <span data-ttu-id="3412a-127">在 Azure 中，服务主体是指代表应用程序/服务（与用户相反）的一个安全标识。</span><span class="sxs-lookup"><span data-stu-id="3412a-127">In Azure, a service principal is a security identity that represents an application/service (as opposed to a user).</span></span> <span data-ttu-id="3412a-128">数据连接在获得授权可访问 Microsoft 365 数据时，会使用此服务主体作为其标识。</span><span class="sxs-lookup"><span data-stu-id="3412a-128">Data connect uses this service principal as its identity when getting authorized access to your Microsoft 365 data.</span></span>
<span data-ttu-id="3412a-129">如果创建供其他人在其租户中使用的 Azure 托管应用程序，仍需为要使用的应用提供服务主体。</span><span class="sxs-lookup"><span data-stu-id="3412a-129">If you create an Azure Managed Application for others to use in their tenants, you'll still provide a service principal for the app to use.</span></span> <span data-ttu-id="3412a-130">该服务主体将存在于你的（发布者的）租户中。</span><span class="sxs-lookup"><span data-stu-id="3412a-130">This service principal will exist in your (the publisher's) tenant.</span></span> <span data-ttu-id="3412a-131">但是如果该应用需要其他服务主体，你的客户（安装者）将在其自己的租户中自行创建。</span><span class="sxs-lookup"><span data-stu-id="3412a-131">However, if the app needs other service principals, your customer (the installer) will create them in their own tenant.</span></span> <span data-ttu-id="3412a-132">例如，数据工厂管道将可能需要访问 Azure 中的存储资源。</span><span class="sxs-lookup"><span data-stu-id="3412a-132">For example, your Data Factory pipeline will likely need access to a storage resource in Azure.</span></span> <span data-ttu-id="3412a-133">客户会创建服务主体，该主体有权存储帐户供管道使用。</span><span class="sxs-lookup"><span data-stu-id="3412a-133">The customer would create the service principal with permissions to the storage account for the pipeline to use.</span></span>

## <a name="check-for-pending-privileged-access-management-requests"></a><span data-ttu-id="3412a-134">检查待处理的 Privileged Access Management 请求</span><span class="sxs-lookup"><span data-stu-id="3412a-134">Check for pending Privileged Access Management requests</span></span>

<span data-ttu-id="3412a-135">Privileged Access Management (PAM) 请求必须得到管理员的批准，然后数据连接才可复制你的数据。</span><span class="sxs-lookup"><span data-stu-id="3412a-135">Before data connect can copy your data, an administrator must approve a Privileged Access Management (PAM) request.</span></span> <span data-ttu-id="3412a-136">PAM 是 Microsoft 365 中向数据管道授予数据访问权限的机制。</span><span class="sxs-lookup"><span data-stu-id="3412a-136">PAM is the mechanism used to authorize your data pipeline access to the data in Microsoft 365.</span></span> <span data-ttu-id="3412a-137">首次触发管道时，它将等待 Microsoft 365 管理员（或指定的代理人）批准访问请求。</span><span class="sxs-lookup"><span data-stu-id="3412a-137">The first time you trigger a pipeline, it will wait on a Microsoft 365 administrator (or appointed delegate) to approve the access request.</span></span> <span data-ttu-id="3412a-138">虽然管道状态显示“**正在进行中**”，但基础复制活动的状态将为 **ConsentPending**，直到获得批准，如以下屏幕截图所示。</span><span class="sxs-lookup"><span data-stu-id="3412a-138">Although the pipeline status shows **In progress**, the underlying copy activity will have a status of **ConsentPending** until approval is granted, as shown in the following screenshot.</span></span>

![具有 ConsentPending 状态的管道运行状态窗格屏幕截图](images/data-connect-tips.png)

<span data-ttu-id="3412a-140">在开发期间，最好确保你的管道运行不一直处于 **ConsentPending** 状态，尤其是在更改管道之后。</span><span class="sxs-lookup"><span data-stu-id="3412a-140">During development, it's a good idea to make sure your pipeline runs aren't stuck on **ConsentPending**, especially after you make a change to your pipeline.</span></span> <span data-ttu-id="3412a-141">例如，如果向架构额外添加了一个字段，则下一次管道运行将发出一个新的 PAM 请求，而该请求必须获得批准。</span><span class="sxs-lookup"><span data-stu-id="3412a-141">For example, if you add an additional field to the schema, the next pipeline run will issue a new PAM request that has to be approved.</span></span> <span data-ttu-id="3412a-142">不要浪费时间等待一个需要你来批准的管道。</span><span class="sxs-lookup"><span data-stu-id="3412a-142">Don't waste time waiting on a pipeline that's waiting for your approval.</span></span>

## <a name="approve-pam-requests-via-microsoft-365-admin-portal"></a><span data-ttu-id="3412a-143">通过 Microsoft 365 管理门户审批 PAM 请求</span><span class="sxs-lookup"><span data-stu-id="3412a-143">Approve PAM requests via Microsoft 365 admin portal</span></span>

<span data-ttu-id="3412a-144">数据连接文档介绍了如何使用 PowerShell 和 PAM UX 来审批 PAM 请求。</span><span class="sxs-lookup"><span data-stu-id="3412a-144">The data connect documentation shows you how to use PowerShell and the PAM UX to approve PAM requests.</span></span> <span data-ttu-id="3412a-145">要通过 PAM UX 进行审批，请访问 [Microsoft 365 管理门户](https://admin.microsoft.com/Adminportal/Home?source=applauncher#/Settings/PrivilegedAccess)中的 PAM 界面。</span><span class="sxs-lookup"><span data-stu-id="3412a-145">To approve using the PAM UX, visit the PAM interface in the [Microsoft 365 admin portal](https://admin.microsoft.com/Adminportal/Home?source=applauncher#/Settings/PrivilegedAccess).</span></span> <span data-ttu-id="3412a-146">该门户让你能够以简单、快捷的方式查看和审批/拒绝/撤消 PAM 请求。</span><span class="sxs-lookup"><span data-stu-id="3412a-146">The portal provides an easy and user-friendly way to view and approve/deny/revoke PAM requests.</span></span> <span data-ttu-id="3412a-147">可访问“**设置**” > “**服务和加载项**” > “**Microsoft Graph 数据连接**”，在 Microsoft Graph 数据连接加载项中查找指向它的链接。</span><span class="sxs-lookup"><span data-stu-id="3412a-147">You can find a link to it in the Microsoft Graph data connect add-in under **Settings** > **Services & Add-ins** > **Microsoft Graph data connect**.</span></span>

## <a name="use-a-second-user-to-approve-pam-requests"></a><span data-ttu-id="3412a-148">使用另一名用户来审批 PAM 请求</span><span class="sxs-lookup"><span data-stu-id="3412a-148">Use a second user to approve PAM requests</span></span>

<span data-ttu-id="3412a-149">运行管道并触发 PAM 请求，该请求会附加到拥有该管道所用服务主体的用户帐户上。</span><span class="sxs-lookup"><span data-stu-id="3412a-149">When you run a pipeline and trigger a PAM request, the request is attached to your user account that owns the service principal used by the pipeline.</span></span> <span data-ttu-id="3412a-150">但即使该帐户属于你设置的审批者组，你也不能用它来审批 PAM 请求，因为不允许自我审批。</span><span class="sxs-lookup"><span data-stu-id="3412a-150">But even if this account is part of the approver group you set up, you can't use it to approve the PAM request because self-approvals are not allowed.</span></span> <span data-ttu-id="3412a-151">如果尝试此操作，你将在 PAM 门户中获得一个错误消息：“请求者和审批者是同一人。</span><span class="sxs-lookup"><span data-stu-id="3412a-151">If you try, you'll get an error message in the PAM portal: "Requestor and approver are the same.</span></span> <span data-ttu-id="3412a-152">不允许自我审批。”</span><span class="sxs-lookup"><span data-stu-id="3412a-152">Self-approval is not allowed."</span></span> <span data-ttu-id="3412a-153">在开发时，你将必须在审批请求的管理员之外再拥有一个帐户。</span><span class="sxs-lookup"><span data-stu-id="3412a-153">For development, you'll want to have a second account in addition to the admin who approves requests.</span></span> <span data-ttu-id="3412a-154">提交者和审批者都必须具有有效的 Exchange Online 帐户。</span><span class="sxs-lookup"><span data-stu-id="3412a-154">Both the submitter and the approver must have active Exchange Online accounts.</span></span>

## <a name="deduplicate-emails-when-needed"></a><span data-ttu-id="3412a-155">必要时删除重复的电子邮件</span><span class="sxs-lookup"><span data-stu-id="3412a-155">Deduplicate emails when needed</span></span>

<span data-ttu-id="3412a-156">从 `Message` 数据集中提取电子邮件时，通常同一封电子邮件有多个 JSON 对象。</span><span class="sxs-lookup"><span data-stu-id="3412a-156">When you extract emails from the `Message` dataset, there will often be multiple JSON objects for the same email.</span></span> <span data-ttu-id="3412a-157">这些重复项存在的原因是在向多名用户发送电子邮件时，每个收件人的邮箱中都有该电子邮件的副本。</span><span class="sxs-lookup"><span data-stu-id="3412a-157">These duplicates exist because when an email is sent to multiple people, there is a copy of the email in every recipient's mailbox.</span></span> <span data-ttu-id="3412a-158">由于数据集是从每个邮箱中提取的，因此它将包含所有用户的所有副本。</span><span class="sxs-lookup"><span data-stu-id="3412a-158">Because the dataset is extracted from every mailbox, it will contain all copies across users.</span></span> <span data-ttu-id="3412a-159">在某些情况下，可能有必要保留每个副本；但在其他情况下，可能必须删除重复项。</span><span class="sxs-lookup"><span data-stu-id="3412a-159">In some scenarios, it might be necessary to keep every copy but in others, you may want to remove the duplicates.</span></span>
<span data-ttu-id="3412a-160">可根据邮件的 `internetMessageId` 删除导出的 JSON 对象中的重复项：具有相同 `internetMessageId` 的两封邮件是同一实例的重复副本。</span><span class="sxs-lookup"><span data-stu-id="3412a-160">You can deduplicate the exported JSON objects based on the `internetMessageId` of the messages: Two messages with the same `internetMessageId` are duplicate copies of the same instance.</span></span> <span data-ttu-id="3412a-161">由于重复项可存在于不同的 blob 中，因此必须删除所有 blob 中的重复项，而不是分别删除每个 blob 中的重复项。</span><span class="sxs-lookup"><span data-stu-id="3412a-161">Because the duplicates can exist in different blobs, you must deduplicate across all blobs rather than deduplicating in each blob separately.</span></span>

## <a name="use-puser-field-to-determine-the-relevant-user"></a><span data-ttu-id="3412a-162">使用 puser 字段来确定相关用户</span><span class="sxs-lookup"><span data-stu-id="3412a-162">Use puser field to determine the relevant user</span></span>

<span data-ttu-id="3412a-163">提取的数据包含一些在使用相应的 Microsoft Graph API 时不存在的属性。</span><span class="sxs-lookup"><span data-stu-id="3412a-163">The extracted data includes some meta properties that don't exist when using the corresponding Microsoft Graph APIs.</span></span> <span data-ttu-id="3412a-164">具体而言，`puser` 在确定用户数据提取的位置时非常有用。</span><span class="sxs-lookup"><span data-stu-id="3412a-164">Specifically, the `puser` field can be useful for determining which user the data was extracted from.</span></span> <span data-ttu-id="3412a-165">如果不同邮箱中具有同一电子邮件的两个副本，可使用 `puser` 字段来确定副本来自哪个邮箱。</span><span class="sxs-lookup"><span data-stu-id="3412a-165">In the scenario where you have two copies of the same email in different mailboxes, you can use the `puser` field to determine which copy came from which mailbox.</span></span>
<span data-ttu-id="3412a-166">`puser` 字段还对 `Manager` 数据集之类的数据集很有用。</span><span class="sxs-lookup"><span data-stu-id="3412a-166">The `puser` field is also useful for datasets such as the `Manager` dataset.</span></span> <span data-ttu-id="3412a-167">导出的 JSON 将包含管理器相关信息，但只有当你知道它们是谁的管理器时，这才有用。</span><span class="sxs-lookup"><span data-stu-id="3412a-167">The exported JSON will contain information about a manager, but this is only useful if you know whose manager they are.</span></span> <span data-ttu-id="3412a-168">`puser` 字段将指出 JSON 对象对应于哪个管理器。</span><span class="sxs-lookup"><span data-stu-id="3412a-168">The `puser` field will tell you whose manager that JSON object corresponds to.</span></span>

## <a name="next-steps"></a><span data-ttu-id="3412a-169">后续步骤</span><span class="sxs-lookup"><span data-stu-id="3412a-169">Next Steps</span></span>

<span data-ttu-id="3412a-170">联系 [Microsoft 365 开发人员平台意见论坛](https://techcommunity.microsoft.com/t5/microsoft-365-developer-platform/idb-p/Microsoft365DeveloperPlatform/label-name/Microsoft%20Graph)提交功能请求。</span><span class="sxs-lookup"><span data-stu-id="3412a-170">Reach out on the [Microsoft 365 Developer Platform ideas forum](https://techcommunity.microsoft.com/t5/microsoft-365-developer-platform/idb-p/Microsoft365DeveloperPlatform/label-name/Microsoft%20Graph) for feature requests.</span></span>